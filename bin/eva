#!/bin/bash

ROOT_DIR="$(cd "$(dirname "$(dirname $0)")" && pwd)"

pp() {
  printf "\e[34m==> \e[1m\e[39m$1\e[0m\n"
}

# install homebrew
echo "Homebrew setup..."
pp "Installing homebrew"
if [[ -z "$(command -v brew)" ]]
then
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
else
  echo "Already installed"
fi

# install brew packages
brew_pkgs="vim python ruby zsh git n ack fzf zsh-autosuggestions zsh-syntax-highlighting htop tmux"
pp "Installing homebrew packages"
for brew_pkg in $brew_pkgs
do
  printf "+ $brew_pkg"
  if [[ -z "$(brew ls --versions $brew_pkg)" ]]
  then
    printf " \e[33m⧖\e[39m\n"
    brew install $brew_pkg
  else
    printf " \e[32m✔\e[39m\n"
  fi
done

# install brew cask packages
brew_cask_pkgs="alfred iterm2"
pp "Installing homebrew cask packages"
for brew_cask_pkg in $brew_cask_pkgs
do
  printf "+ $brew_cask_pkg"
  if [[ -z "$(brew cask ls --versions $brew_cask_pkg)" ]]
  then
    printf " \e[33m⧖\e[39m\n"
    brew cask install $brew_cask_pkg
  else
    printf " \e[32m✔\e[39m\n"
  fi
done

# install oh-my-zsh
echo "Oh-my-zsh setup..."
pp "Installing oh-my-zsh"
if [[ ! -d ~/.oh-my-zsh ]]
then
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
else
  echo "Already installed"
fi

pp "Configuring oh-my-zsh"
# configure git.plugin.zsh
if [[ "$(tail -n 1 ~/.oh-my-zsh/plugins/git/git.plugin.zsh)" != "# GENERATED BY @cosmoz/eva - END" ]]
then
  cat ${ROOT_DIR}/git.plugin.zsh >> ~/.oh-my-zsh/plugins/git/git.plugin.zsh
fi
# configure .zshrc
cp ${ROOT_DIR}/zshrc ~/.zshrc && source ~/.zshrc &>/dev/null
echo "$(cd ~/.oh-my-zsh/plugins/git && pwd)/git.plugin.zsh"
echo "$(cd && pwd)/.zshrc"

# tmux
echo "Tmux setup..."
pp "Installing tpm"
if [[ ! -d ~/.tmux/plugins/tpm ]]
then
  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
fi

pp "Configuring tmux"
cp ${ROOT_DIR}/tmux.conf ~/.tmux.conf && tmux source ~/.tmux.conf
echo "$(cd && pwd)/.tmux.conf"
pp "Installing tmux plugins"
~/.tmux/plugins/tpm/bin/install_plugins

# vim
echo "Vim setup..."
pp "Installing vim-plug"
if [[ ! -f ~/.vim/autoload/plug.vim ]]
then
  curl -fLo ~/.vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
else
  echo "Already installed"
fi
pp "Configuring vim"
cp ${ROOT_DIR}/vimrc ~/.vimrc && source ~/.vimrc &>/dev/null
echo "$(cd && pwd)/.vimrc"
pp "Installing vim plugins"
vim ~/.vimrc -c ':PlugInstall' -c ':q' -c ':q' && npm i -g flow-language-server
